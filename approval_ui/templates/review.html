<!DOCTYPE html>
<html>
<head>
    <title>Claim Review</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script>
        async function updateStatus(claimId, status) {
            const confirmMsg = `Yakin ingin set status menjadi: ${status}?`;
            if (!confirm(confirmMsg)) return;

            const res = await fetch(`/api/update_status/${claimId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: status })
            });

            const data = await res.json();
            if (data.success) {
                alert("Status updated!");
                window.location.href = "/dashboard";
            } else {
                alert("Error: " + data.error);
            }
        }
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen">

<div class="max-w-6xl mx-auto py-10">

    <a href="/dashboard" class="text-blue-400 hover:underline">&larr; Back to Dashboard</a>

    <h1 class="text-3xl font-bold mt-4">Claim Review #{{ claim.claim_id }}</h1>

    <div class="grid grid-cols-2 gap-6 mt-6">
        <!-- LEFT SIDE -->
        <div class="bg-gray-800 p-6 rounded-xl shadow">
            <h2 class="text-xl font-semibold mb-4">Claim Information</h2>
            <p><strong>Patient:</strong> {{ claim.patient_name }}</p>
            <p><strong>Age:</strong> {{ claim.patient_age or 'N/A' }}</p>
            <p><strong>Visit Date:</strong> {{ claim.visit_date }}</p>
            <p><strong>Type:</strong> {{ claim.visit_type }}</p>
            <p><strong>Department:</strong> {{ claim.department }}</p>
            <p><strong>Total Claim:</strong> Rp {{ claim.total_claim_amount }}</p>
            <p><strong>Diagnosis:</strong>
                {{ claim.icd10_primary_code }} - {{ claim.icd10_primary_description }}
            </p>
            <p><strong>Status:</strong>
                <span class="text-yellow-300">{{ claim.status }}</span>
            </p>
        </div>

        <!-- RIGHT SIDE (FRAUD SCORE) -->
        <div class="bg-gray-800 p-6 rounded-xl shadow">
            <h2 class="text-xl font-semibold mb-4">Fraud Scoring</h2>

            <p><strong>Fraud Score:</strong>
                <span class="text-green-400 text-2xl">{{ scoring.model_output.fraud_score }}</span>
            </p>

            <p class="mt-2">
                <strong>Suspicious Sections:</strong>
                {{ scoring.model_output.suspicious_sections }}
            </p>

            <p class="mt-2">
                <strong>Rule Violations:</strong>
                {{ scoring.model_output.rule_violations }}
            </p>

            <div class="mt-4">
                <strong>AI Explanation:</strong>
                <div class="bg-gray-700 p-3 rounded mt-1 text-gray-200 whitespace-pre-line">
                    {{ scoring.ai_explanation }}
                </div>
            </div>
        </div>
    </div>

    <!-- PROCEDURE LIST -->
    <div class="bg-gray-800 p-6 rounded-xl shadow mt-8">
        <h2 class="text-xl font-semibold mb-4">Procedures</h2>
        {% if procedures %}
        <table class="w-full text-left">
            <tr class="text-gray-400">
                <th class="p-2">ICD9</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Date</th>
            </tr>
            {% for p in procedures %}
            <tr class="border-t border-gray-700">
                <td class="p-2">{{ p.icd9_code }}</td>
                <td>{{ p.icd9_description }}</td>
                <td>{{ p.quantity }}</td>
                <td>{{ p.procedure_date }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p class="text-gray-400">No procedures.</p>
        {% endif %}
    </div>

    <!-- DRUG LIST -->
    <div class="bg-gray-800 p-6 rounded-xl shadow mt-8">
        <h2 class="text-xl font-semibold mb-4">Drugs</h2>
        {% if drugs %}
        <table class="w-full text-left">
            <tr class="text-gray-400">
                <th class="p-2">Code</th>
                <th>Name</th>
                <th>Dosage</th>
                <th>Days</th>
                <th>Cost</th>
            </tr>
            {% for d in drugs %}
            <tr class="border-t border-gray-700">
                <td class="p-2">{{ d.drug_code }}</td>
                <td>{{ d.drug_name }}</td>
                <td>{{ d.dosage }}</td>
                <td>{{ d.days }}</td>
                <td>{{ d.cost }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p class="text-gray-400">No drug records.</p>
        {% endif %}
    </div>

    <!-- VITAMIN LIST -->
    <div class="bg-gray-800 p-6 rounded-xl shadow mt-8">
        <h2 class="text-xl font-semibold mb-4">Vitamins</h2>
        {% if vitamins %}
        <table class="w-full text-left">
            <tr class="text-gray-400">
                <th class="p-2">Vitamin</th>
                <th>Dosage</th>
                <th>Days</th>
                <th>Cost</th>
            </tr>
            {% for v in vitamins %}
            <tr class="border-t border-gray-700">
                <td class="p-2">{{ v.vitamin_name }}</td>
                <td>{{ v.dosage }}</td>
                <td>{{ v.days }}</td>
                <td>{{ v.cost }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p class="text-gray-400">No vitamin records.</p>
        {% endif %}
    </div>

    <!-- ACTION BUTTONS -->
    <div class="mt-10 text-center">
        <h2 class="text-xl font-semibold mb-4">Take Action</h2>

        <button onclick="updateStatus('{{ claim.claim_id }}', 'approved')"
            class="bg-green-500 px-4 py-2 rounded hover:bg-green-600 mx-2">
            Approve
        </button>

        <button onclick="updateStatus('{{ claim.claim_id }}', 'approved_partial')"
            class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-600 mx-2">
            Approve Partial
        </button>

        <button onclick="updateStatus('{{ claim.claim_id }}', 'declined')"
            class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 mx-2">
            Decline
        </button>

        <button onclick="updateStatus('{{ claim.claim_id }}', 'manual_review')"
            class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 mx-2">
            Manual Review
        </button>

        <button onclick="updateStatus('{{ claim.claim_id }}', 'request_docs')"
            class="bg-purple-600 px-4 py-2 rounded hover:bg-purple-700 mx-2">
            Request Additional Document
        </button>

    </div>

</div>

</body>
</html>