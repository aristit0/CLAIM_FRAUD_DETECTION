<!DOCTYPE html>
<html>
<head>
    <title>Claim Review</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script>
        async function updateStatus(claimId, status) {
            if (!confirm(`Yakin ingin set status menjadi: ${status}?`)) return;

            const res = await fetch(`/api/update_status/${claimId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status })
            });

            const data = await res.json();
            if (data.success) {
                alert("Status updated!");
                window.location.href = "/dashboard";
            } else {
                alert("Error: " + data.error);
            }
        }
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen">

<div class="max-w-7xl mx-auto py-10">

    <a href="/dashboard" class="text-blue-400 hover:underline">&larr; Back</a>

    <h1 class="text-3xl font-bold mt-4">Claim Review #{{ header.claim_id }}</h1>

    <div class="grid grid-cols-2 gap-6 mt-6">

        <!-- LEFT PANEL -->
        <div class="bg-gray-800 p-6 rounded-xl shadow">

            <h2 class="text-xl font-semibold mb-4">Patient & Visit Info</h2>

            <p><strong>Patient:</strong> {{ header.patient_name }}</p>
            <p><strong>Gender:</strong> {{ header.patient_gender }}</p>
            <p><strong>DOB:</strong> {{ header.patient_dob }}</p>
            <p><strong>Address:</strong> {{ header.patient_address }}</p>
            <p><strong>Phone:</strong> {{ header.patient_phone }}</p>

            <hr class="my-3 border-gray-700">

            <p><strong>Visit Date:</strong> {{ header.visit_date }}</p>
            <p><strong>Visit Type:</strong> {{ header.visit_type }}</p>
            <p><strong>Department:</strong> {{ header.department }}</p>
            <p><strong>Doctor:</strong> {{ header.doctor_name }}</p>

            <hr class="my-3 border-gray-700">

            <p><strong>Total Claim:</strong>
                <span class="text-green-300 text-lg">{{ header.total_claim_amount | rupiah }}</span>
            </p>

            <p><strong>Status:</strong>
                <span class="text-yellow-300">{{ header.status }}</span>
            </p>
        </div>

        <!-- RIGHT PANEL (FRAUD ANALYSIS) -->
        <div class="bg-gray-800 p-6 rounded-xl shadow">

            <h2 class="text-xl font-semibold mb-4">Fraud Analysis</h2>

            {% set m = scoring.model_output %}

            <p><strong>Fraud Score:</strong>
                <span class="text-2xl font-bold
                    {% if m.fraud_score >= 0.5 %}text-red-400{% else %}text-green-400{% endif %}">
                    {{ m.fraud_score | round(3) }}
                </span>
            </p>

            <p class="mt-2">
                <strong>Final Flag:</strong>
                {% if m.final_flag == 1 %}
                    <span class="text-red-400 font-semibold">Potential Fraud</span>
                {% else %}
                    <span class="text-green-400 font-semibold">Normal</span>
                {% endif %}
            </p>

            {% if m.rule_flag %}
                <p class="mt-2">
                    <strong>Rule Flag:</strong> {{ m.rule_flag }}
                </p>
                <p class="text-sm text-gray-300">{{ m.rule_reason }}</p>
            {% endif %}

            <p class="mt-4 mb-2"><strong>Suspicious Sections:</strong></p>
            <div class="flex flex-wrap gap-2">
                {% for s in m.suspicious_sections %}
                    <span class="px-2 py-1 bg-red-700 rounded text-sm">{{ s }}</span>
                {% else %}
                    <span class="text-gray-400">None</span>
                {% endfor %}
            </div>

            <!-- Feature Importance -->
            {% if m.feature_importance %}
            <div class="mt-6">
                <h3 class="font-semibold mb-2">Top Contributing Features</h3>

                {% set top = m.feature_importance[0].importance %}
                <div class="space-y-2 max-h-48 overflow-y-auto pr-2">

                    {% for item in m.feature_importance %}
                        {% set pct = ((item.importance / top) * 100) | round(2) %}

                        <div>
                            <div class="flex justify-between text-sm text-gray-300">
                                <span>{{ item.feature }}</span>
                                <span>{{ item.importance | round(1) }}</span>
                            </div>
                            <div class="w-full bg-gray-700 h-2 rounded">
                                <div class="bg-blue-400 h-2 rounded" style="width: {{ pct }}%"></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- AI Explanation -->
            <div class="mt-6">
                <h3 class="font-semibold mb-2">AI Explanation</h3>

                <div class="bg-gray-700 p-3 rounded text-sm whitespace-pre-line">
                    {{ scoring.ai_explanation }}
                </div>
            </div>
        </div>
    </div>


    <!-- ========================== -->
    <!-- DIAGNOSIS -->
    <!-- ========================== -->
    <div class="bg-gray-800 p-6 rounded-xl shadow mt-8">
        <h2 class="text-xl font-semibold mb-4">Diagnosis</h2>

        <table class="w-full text-left">
            <thead class="text-gray-400">
                <tr>
                    <th class="p-2">ICD10</th>
                    <th>Description</th>
                    <th>Primary?</th>
                </tr>
            </thead>

            {% for d in diagnosis %}
            <tr class="border-t border-gray-700">
                <td class="p-2">{{ d.icd10_code }}</td>
                <td>{{ d.icd10_description }}</td>
                <td>
                    {% if d.is_primary %}
                        <span class="px-2 py-1 bg-blue-600 rounded text-xs">Yes</span>
                    {% else %}
                        <span class="px-2 py-1 bg-gray-600 rounded text-xs">No</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>


    <!-- ========================== -->
    <!-- PROCEDURES -->
    <!-- ========================== -->
    <div class="bg-gray-800 p-6 rounded-xl shadow mt-8">
        <h2 class="text-xl font-semibold mb-4">Procedures</h2>

        <table class="w-full text-left">
            <thead class="text-gray-400">
                <tr>
                    <th class="p-2">ICD9</th>
                    <th>Description</th>
                    <th>Cost</th>
                </tr>
            </thead>

            {% for p in procedures %}
            <tr class="border-t border-gray-700">
                <td class="p-2">{{ p.icd9_code }}</td>
                <td>{{ p.icd9_description }}</td>
                <td>{{ p.cost | rupiah }}</td>
            </tr>
            {% endfor %}
        </table>

        <p class="mt-3 text-green-300"><strong>Total:</strong> {{ header.total_procedure_cost | rupiah }}</p>
    </div>


    <!-- ========================== -->
    <!-- DRUGS -->
    <!-- ========================== -->
    <div class="bg-gray-800 p-6 rounded-xl shadow mt-8">
        <h2 class="text-xl font-semibold mb-4">Drugs</h2>

        <table class="w-full text-left">
            <thead class="text-gray-400">
                <tr>
                    <th class="p-2">Code</th>
                    <th>Name</th>
                    <th>Cost</th>
                </tr>
            </thead>

            {% for d in drugs %}
            <tr class="border-t border-gray-700">
                <td class="p-2">{{ d.drug_code }}</td>
                <td>{{ d.drug_name }}</td>
                <td>{{ d.cost | rupiah }}</td>
            </tr>
            {% endfor %}
        </table>

        <p class="mt-3 text-green-300"><strong>Total:</strong> {{ header.total_drug_cost | rupiah }}</p>
    </div>


    <!-- ========================== -->
    <!-- VITAMINS -->
    <!-- ========================== -->
    <div class="bg-gray-800 p-6 rounded-xl shadow mt-8">
        <h2 class="text-xl font-semibold mb-4">Vitamins</h2>

        <table class="w-full text-left">
            <thead class="text-gray-400">
                <tr>
                    <th class="p-2">Vitamin</th>
                    <th>Cost</th>
                </tr>
            </thead>

            {% for v in vitamins %}
            <tr class="border-t border-gray-700">
                <td class="p-2">{{ v.vitamin_name }}</td>
                <td>{{ v.cost | rupiah }}</td>
            </tr>
            {% endfor %}
        </table>

        <p class="mt-3 text-green-300"><strong>Total:</strong> {{ header.total_vitamin_cost | rupiah }}</p>
    </div>



    <!-- ACTION BUTTONS -->
    <div class="mt-10 text-center">
        <h2 class="text-xl font-semibold mb-4">Take Action</h2>

        <button onclick="updateStatus('{{ header.claim_id }}', 'approved')" class="bg-green-600 px-4 py-2 rounded">
            Approve
        </button>

        <button onclick="updateStatus('{{ header.claim_id }}', 'approved_partial')" class="bg-yellow-600 px-4 py-2 rounded">
            Approve Partial
        </button>

        <button onclick="updateStatus('{{ header.claim_id }}', 'declined')" class="bg-red-600 px-4 py-2 rounded">
            Decline
        </button>

        <button onclick="updateStatus('{{ header.claim_id }}', 'manual_review')" class="bg-blue-600 px-4 py-2 rounded">
            Manual Review
        </button>

        <button onclick="updateStatus('{{ header.claim_id }}', 'request_docs')" class="bg-purple-600 px-4 py-2 rounded">
            Request Docs
        </button>
    </div>

</div>

</body>
</html>