{% extends "layout.html" %}
{% block content %}

<div class="card p-4 shadow-sm">
    <h4 class="mb-3">Submit Claim (UI v2)</h4>

    {% if msg %}
    <div class="alert alert-success">{{ msg }}</div>
    {% endif %}

    <form method="POST">

        <h5>Data Pasien</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Nama Pasien</label>
                <input class="form-control" name="patient_name" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>NIK</label>
                <input class="form-control" name="patient_nik" required>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label>Tanggal Lahir</label>
                <input class="form-control" type="date" name="patient_dob" required>
            </div>

            <div class="col-md-4 mb-3">
                <label>Jenis Kelamin</label>
                <select class="form-control" name="patient_gender" required>
                    <option value="M">Laki-laki</option>
                    <option value="F">Perempuan</option>
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label>No. Telepon</label>
                <input class="form-control" name="patient_phone">
            </div>
        </div>

        <div class="mb-3">
            <label>Alamat</label>
            <input class="form-control" name="patient_address">
        </div>

        <hr>

        <h5>Data Kunjungan</h5>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Tanggal Kunjungan</label>
                <input class="form-control" type="date" name="visit_date" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>Jenis Kunjungan</label>
                <select class="form-control" name="visit_type">
                    <option>rawat jalan</option>
                    <option>rawat inap</option>
                    <option>igd</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Dokter Pemeriksa</label>
                <input class="form-control" name="doctor_name" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>Department</label>
                <select class="form-control" name="department">
                    <option>Poli Umum</option>
                    <option>Poli Anak</option>
                    <option>Poli Saraf</option>
                    <option>IGD</option>
                    <option>Poli Gigi</option>
                </select>
            </div>
        </div>

        <hr>

        <h5>Data Medis</h5>

        <div class="mb-3">
            <label>Diagnosis Utama (ICD-10)</label>
            <select class="form-control" name="diagnosis_primary" required id="dx_primary">
                {% for code, desc in ICD10 %}
                <option value="{{ code }}">{{ code }} - {{ desc }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label>Diagnosis Sekunder (Opsional)</label>
            <select class="form-control" name="diagnosis_secondary" id="dx_secondary">
                <option value="">- Tidak Ada -</option>
                {% for code, desc in ICD10 %}
                <option value="{{ code }}">{{ code }} - {{ desc }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label>Tindakan (ICD-9)</label>
            <select class="form-control" name="procedure" required id="px_code">
                {% for code, desc in ICD9 %}
                <option value="{{ code }}">{{ code }} - {{ desc }}</option>
                {% endfor %}
            </select>
        </div>

        <hr>

        <h5>Obat</h5>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Kode Obat</label>
                <select class="form-control" name="drug_code" id="drug_code">
                    {% for code, name in DRUGS %}
                    <option value="{{ code }}">{{ code }} - {{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label>Biaya Obat</label>
                <input type="number" name="drug_cost" class="form-control" id="drug_cost" placeholder="0">
            </div>
        </div>

        <hr>

        <h5>Vitamin</h5>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Vitamin</label>
                <select class="form-control" name="vitamin_name" id="vitamin_name">
                    {% for v in VITAMINS %}
                    <option>{{ v }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-6 mb-3">
                <label>Biaya Vitamin</label>
                <input type="number" name="vitamin_cost" class="form-control" id="vitamin_cost" placeholder="0">
            </div>
        </div>

        <hr>

        <h5>Biaya Tindakan</h5>

        <div class="mb-3">
            <label>Biaya Prosedur</label>
            <input type="number" class="form-control" name="procedure_cost" id="procedure_cost" required>
        </div>

        <hr>

        <!-- ============================================================ -->
        <!-- AUTO-FILL BUTTONS -->
        <!-- ============================================================ -->

        <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-success w-50" onclick="fillNormal();">Auto-Fill Normal</button>
            <button type="button" class="btn btn-danger w-50" onclick="fillFraud();">Auto-Fill Fraud (Tindakan Tidak Relevan)</button>
        </div>

        <button class="btn btn-primary w-100">Submit Claim</button>

    </form>
</div>

<!-- ============================================================ -->
<!-- JAVASCRIPT AUTO-FILL SECTION (FIXED & DYNAMIC) -->
<!-- ============================================================ -->
<script>
    function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    // Convert Jinja list â†’ JS arrays
    const ICD10 = JSON.parse(`{{ ICD10|tojson|safe }}`);
    const ICD9 = JSON.parse(`{{ ICD9|tojson|safe }}`);
    const DRUGS = JSON.parse(`{{ DRUGS|tojson|safe }}`);
    const VITAMINS = JSON.parse(`{{ VITAMINS|tojson|safe }}`);

    /* ==========================================================
       AUTO-DETECT VALUES FROM DROPDOWN
    ========================================================== */

    // Ambil ICD10 yang dimulai dengan "J06"
    let ICD10_J06 = ICD10.find(x => x[0].startsWith("J06"));
    ICD10_J06 = ICD10_J06 ? ICD10_J06[0] : ICD10[0][0];   // fallback

    // Ambil procedure pertama yang paling mirip untuk J06 (gunakan pattern)
    let PROCEDURE_J06 = ICD9.find(x =>
        x[1].toLowerCase().includes("injeksi") ||
        x[1].toLowerCase().includes("nebul")
    );
    PROCEDURE_J06 = PROCEDURE_J06 ? PROCEDURE_J06[0] : ICD9[0][0];

    // Ambil paracetamol otomatis
    let DRUG_J06 = DRUGS.find(x =>
        x[1].toLowerCase().includes("paracetamol")
    );
    DRUG_J06 = DRUG_J06 ? DRUG_J06[0] : DRUGS[0][0];

    // Vitamin valid = Vitamin C (jika ada)
    let VALID_VIT_J06 = VITAMINS.find(v =>
        v.toLowerCase().includes("vitamin c")
    );
    VALID_VIT_J06 = VALID_VIT_J06 || VITAMINS[0];

    // Vitamin invalid = semua kecuali vitamin C
    const INVALID_VIT_J06 = VITAMINS.filter(v =>
        !v.toLowerCase().includes("vitamin c")
    );

    /* ==========================================================
       AUTO-FILL NORMAL
    ========================================================== */
    function fillNormal() {

        document.querySelector("input[name='patient_name']").value = "Budi Santoso";
        document.querySelector("input[name='patient_nik']").value = "3174091501800004";
        document.querySelector("input[name='patient_dob']").value = "1980-01-15";
        document.querySelector("select[name='patient_gender']").value = "M";
        document.querySelector("input[name='patient_phone']").value = "081234567890";
        document.querySelector("input[name='patient_address']").value = "Jl. Merdeka No.10 Jakarta";

        document.querySelector("input[name='visit_date']").value = "2025-01-02";
        document.querySelector("select[name='visit_type']").value = "rawat jalan";
        document.querySelector("input[name='doctor_name']").value = "Dr. Ratna Sari";
        document.querySelector("select[name='department']").value = "Poli Umum";

        // Diagnosis VALID
        document.getElementById("dx_primary").value = ICD10_J06;

        // Procedure VALID
        document.getElementById("px_code").value = PROCEDURE_J06;

        // Drug VALID
        document.getElementById("drug_code").value = DRUG_J06;
        document.getElementById("drug_cost").value = 50000;

        // Vitamin VALID
        document.getElementById("vitamin_name").value = VALID_VIT_J06;
        document.getElementById("vitamin_cost").value = 20000;

        // Biaya tindakan
        document.getElementById("procedure_cost").value = 80000;
    }

    /* ==========================================================
       AUTO-FILL FRAUD (Vitamin mismatch)
    ========================================================== */
    function fillFraud() {

        document.querySelector("input[name='patient_name']").value = "Siti Rahmawati";
        document.querySelector("input[name='patient_nik']").value = "3175024302750006";
        document.querySelector("input[name='patient_dob']").value = "1975-02-13";
        document.querySelector("select[name='patient_gender']").value = "F";
        document.querySelector("input[name='patient_phone']").value = "081298765432";
        document.querySelector("input[name='patient_address']").value = "Jl. Mawar No.55 Bekasi";

        document.querySelector("input[name='visit_date']").value = "2025-01-03";
        document.querySelector("select[name='visit_type']").value = "rawat jalan";
        document.querySelector("input[name='doctor_name']").value = "Dr. Wibisana";
        document.querySelector("select[name='department']").value = "Poli Saraf";

        // Diagnosis VALID
        document.getElementById("dx_primary").value = ICD10_J06;

        // Procedure VALID
        document.getElementById("px_code").value = PROCEDURE_J06;

        // Obat VALID
        document.getElementById("drug_code").value = DRUG_J06;
        document.getElementById("drug_cost").value = 60000;

        // Vitamin INVALID
        document.getElementById("vitamin_name").value = rand(INVALID_VIT_J06);
        document.getElementById("vitamin_cost").value = 45000;

        // Prosedur cost tetap normal
        document.getElementById("procedure_cost").value = 85000;
    }
</script>

{% endblock %}